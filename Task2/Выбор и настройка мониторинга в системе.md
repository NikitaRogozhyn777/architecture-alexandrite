# Задание 2. Выбор и настройка мониторинга в системе

## Мотивация:
На данный момент компания работает в режиме постоянного «тушения пожаров» — проблемы обнаруживаются только когда клиенты начинают жаловаться на зависшие заказы или операторы сообщают о тормозящем интерфейсе MES. Такой подход напоминает езду на автомобиле с завязанными глазами: вы понимаете, что столкнулись с проблемой, только услышав удар. Мониторинг станет тем самым «зрением», которое позволит:

### 1. Видеть проблемы до того, как они ударят по бизнесу
Представьте, что система могла бы сама сообщать: «Расчет стоимости начал занимать в 3 раза больше времени» или «Очередь заказов в RabbitMQ достигла критического объема». Такие предупреждения приходили бы за часы до первых жалоб клиентов, давая время на исправление. Например, обнаружив рост времени обработки, можно автоматически добавить вычислительные мощности или перенаправить поток заказов.

### 2. Понимать реальные причины сбоев
В текущей реализации, при проблемах с заказами начинается долгий разбор: это MES не успевает обрабатывать запросы? CRM теряет сообщения? Или сбой где-то в интеграциях? Мониторинг с трейсингом покажет всю цепочку: как заказ проходит через системы, где именно возникает задержка, какие запросы к БД выполняются слишком долго. Это сократит время диагностики с часов до минут.

### 3. Делать обоснованные решения по инфраструктуре
Мониторинг даёт четкие данные для последующего принятия решений по изменению инфраструктуры: процессор упирается в лимиты? Не хватает оперативной памяти? Диски не справляются с нагрузкой? Это позволит оптимизировать затраты на инфраструктуру, добавляя ресурсы именно туда, где они действительно нужны.

### 4. Создать прозрачность для клиентов и партнеров
Когда B2B-партнер спрашивает «Где мой заказ?», на данный момент, менеджеру приходится вручную проверять несколько систем. С мониторингом можно будет дать точный ответ: «Ваш заказ на расчете стоимости, среднее время обработки сейчас — 15 минут». Это повысит доверие и сократит количество гневных писем.

### 5. Перейти от хаотичных исправлений к системной оптимизации
Собрав данные за месяц работы, можно будет увидеть: расчет стоимости занимает 80% времени обработки заказа; пиковая нагрузка на БД приходится на 11:00; каждый пятый запрос к API повторный. Эти инсайты станут основой для точечных оптимизаций, которые дадут реальный эффект, а не просто «заметают проблему под ковер».


## Выбор подхода к мониторингу:

Для комплексного контроля системы мы применяем комбинацию методологий мониторинга, адаптированных под разные компоненты:

### Методологии мониторинга

#### 1. Четыре золотых сигнала (CRM, онлайн-магазин)

Этот подход фокусируется на ключевых метриках, которые напрямую влияют на пользовательский опыт:

**Фокус:** Пользовательский опыт
- **Задержка (Latency)**: Время обработки ключевых запросов (отправка заказа, расчет стоимости).
- **Трафик (Traffic)**: Количество запросов к API, активных сессий пользователей.
- **Ошибки (Errors)**: Процент неудачных операций (например, падения при загрузке 3D-моделей).
- **Насыщение (Saturation)**: Загрузка системы

#### 2. USE (MES и инфраструктура)

Этот подход лучше подходит для инфраструктурных компонентов:

**Фокус:** Ресурсы и производительность
- **Utilization**: Использование CPU/RAM/дисков
- **Saturation**: Длина очереди в RabbitMQ, время ожидания расчетов стоимости.
- **Errors**: Аппаратные и системные сбои

#### 3. RED (API и интеграции)

Этот подход идеален для мониторинга микросервисов и внешних API:

**Фокус:** Работа сервисов
- **Rate**: Сколько запросов в секунду получает API.
- **Errors**: Ошибки выполнения (например, количество 5xx-ошибок, сбоев в интеграциях)
- **Duration**: Время обработки (например, как долго работает расчет стоимости, синхронизация статусов)

### Реализация в системе

| Компонент          | Методология       | Ключевые метрики                          |
|--------------------|------------------|------------------------------------------|
| Онлайн-магазин    | 4 золотых сигнала | Время загрузки, % ошибок, активные сессии |
| CRM               | 4 золотых сигнала | Задержки, открытые заявки                |
| MES (бэкенд)      | USE              | CPU/RAM, очереди, время расчетов         |
| API MES           | RED              | RPS, таймауты, ошибки                    |
| База данных       | USE              | IOPS, подключения                        |
| RabbitMQ          | USE              | Длина очереди, время обработки           |

В сложной системе, такой как «Александрит», разные компоненты требуют принципиально разных подходов к мониторингу. Попытка использовать единую методологию для всех частей системы привела бы либо к избыточным метрикам, либо к слепым зонам в критически важных областях. Вот почему сознательно используется гибридный подход.

## Система мониторинга: ключевые метрики

### RabbitMQ
| Метрика | Описание | Теги |
|---------|----------|------|
| `rabbitmq_dead_letters_total` | Количество сообщений в dead-letter queue (критично для интеграций) | `queue`, `error_type`, `service=CRM/MES` |
| `rabbitmq_messages_in_flight` | Сообщения в обработке (индикатор заторов) | `queue`, `consumer_group` |

### Производительность API
| Метрика | Описание | Теги |
|---------|----------|------|
| `api_requests_total` | Общее количество запросов | `service=shop/CRM/MES`, `endpoint`, `method` |
| `api_request_duration_seconds` | Время обработки запросов | `service`, `endpoint`, `status` |
| `api_errors_total` | Количество ошибок 5xx | `service`, `endpoint`, `error_code` |

### Использование ресурсов
| Метрика | Описание | Теги |
|---------|----------|------|
| `cpu_usage_percent` | Загрузка CPU | `service`, `instance` |
| `memory_usage_bytes` | Использование памяти | `service`, `instance` |
| `db_connections` | Активные подключения к БД | `db_type=shop/MES`, `instance` |

### Бизнес-метрики
| Метрика | Описание | Теги |
|---------|----------|------|
| `active_sessions` | Активные пользовательские сессии | `service`, `user_type` |
| `data_transfer_bytes` | Объем передаваемых данных | `service`, `direction=in/out` |

### Хранилище
| Метрика | Описание | Теги |
|---------|----------|------|
| `storage_size_bytes` | Используемое место | `storage_type=S3/DB`, `bucket/table` |

## План действий по задачам для реализации инфраструктуры мониторинга:

### 1.1 Развертывание Prometheus
**Цель:** Создать отказоустойчивый кластер для сбора метрик
- **Технологии:**
  - Prometheus Operator (3 ноды)
  - Thanos для долгосрочного хранения
- **Требования к серверам:**
  - 16GB RAM на ноду
  - 500GB SSD дискового пространства
  - Размещение в разных availability zones

### 1.2 Установка Grafana
- **Конфигурация:**
  - 2 инстанса за балансировщиком нагрузки
  - Автоматическая настройка дашбордов через Terraform

### 2. Настройка сбора метрик

### 2.1 Экспортеры метрик
| Компонент | Экспортер | Особенности настройки |
|-----------|-----------|-----------------------|
| RabbitMQ | rabbitmq_exporter | Теги по именам очередей |
| PostgreSQL | postgres_exporter | Мониторинг активных запросов |
| Приложения | micrometer | Встроенный в Spring Boot/C# |

### 2.2 Параметры сбора
| Источник | Интервал | Таймаут | Retention |
|----------|----------|---------|-----------|
| MES API | 15s | 10s | 30 дней |
| БД | 1m | 30s | 1 год |

## 3. Основные категории при построении дашбордов

### Бизнес-метрики
- **Назначение:** Мониторинг ключевых показателей эффективности бизнес-процессов
- **Основные показатели:**
  - Конверсия заказов (от создания до оплаты)
  - Среднее время выполнения заказа
  - Географическое распределение заказов
  - Динамика заказов по типам изделий

### Технические метрики
- **Назначение:** Контроль работоспособности системных компонентов
- **Основные показатели:**
  - Доступность API (uptime)
  - Время ответа сервисов
  - Частота ошибок
  - Загрузка вычислительных ресурсов

### Операционные метрики
- **Назначение:** Мониторинг производственных процессов
- **Основные показатели:**
  - Статусы заказов в работе
  - Очереди обработки
  - Производительность операторов
